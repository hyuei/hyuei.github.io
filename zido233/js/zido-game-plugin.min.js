const AJAX_DEBOUNCE_TIME=1e3;class ZidoAPI{constructor(){this.gameData={score:0,data:{}},this.ajax=this.ajax.bind(this),this.handleMessage=this.handleMessage.bind(this),this.handleAjaxAnswer=this.handleAjaxAnswer.bind(this),this.sendData=this.sendData.bind(this),this.debouncedSendData=debounce(this.sendData,AJAX_DEBOUNCE_TIME),window.addEventListener('message',this.handleMessage),window.addEventListener('unload',this.sendData);const a=document.createElement('link');a.href='https://fonts.googleapis.com/css?family=Cairo:400,700&amp;subset=arabic',a.rel='stylesheet',document.head.appendChild(a)}handleMessage(a){if(a.data){const{api:b,token:c,gameId:d}=a.data;b&&c&&d&&(this.api=b,this.token=c,this.gameId=d,this.ajax({},this.handleAjaxAnswer),sendCustomEvent('gotmessage'))}}handleAjaxAnswer(a){const b=a.target,{readyState:c,status:d,responseText:e}=b;if(4===c){if(200!==d)return void showError('\u0627\u0644\u0645\u0631\u062C\u0648 \u0627\u0644\u062A\u0623\u0643\u062F \u0645\u0646 \u0635\u0644\u0627\u062D\u064A\u0627\u062A \u0627\u0644\u062D\u0633\u0627\u0628 \u0627\u0644\u0645\u0633\u062A\u0639\u0645\u0644',`خطأ ${d}`);this.gameData=JSON.parse(e);const{lastGameDate:a}=this.gameData,{enableIntroVideo:b,introURL:c,allowedDomains:f}=this.gameData.config;if(this.gameData.data||(this.gameData.data={}),!isDomainAllowed(getHostname(),f))return void showError('\u063A\u064A\u0631 \u0645\u0633\u0645\u0648\u062D \u0628\u0627\u0644\u062F\u062E\u0648\u0644');sendCustomEvent('startload');b?showVideo(c,null!==a):sendCustomEvent('startgame')}}sendData(){const{api:a,token:b,gameId:c}=this;if(a&&b&&c){const{score:a,data:b}=this.gameData,c={};c.score=a,c.data=b,c.lastGameDate=new Date,this.ajax({method:'POST',data:c})}}ajax(a,b){const{method:c='GET',url:d=`${this.api}/games/${this.gameId}`,token:e=this.token,data:f={}}=a;var g=new XMLHttpRequest;g.open(c,d,!0),g.setRequestHeader('content-type','application/json'),g.setRequestHeader('authorization',e),'function'==typeof b&&g.addEventListener('readystatechange',b),g.send(JSON.stringify(f))}addScore(a){return isNaN(a)?void 0:!this.gameData.score||isNaN(this.gameData.score)?void(this.gameData.score=a):void(this.gameData.score+=a,this.debouncedSendData())}setScore(a){null===a||isNaN(a)||(this.gameData.score=a,this.debouncedSendData())}setData(a){this.gameData.data=Object.assign({},this.gameData.data,a),this.debouncedSendData()}}'undefined'==typeof exports?window.ZidoAPI=new ZidoAPI:('undefined'!=typeof module&&module.exports&&(exports=module.exports),exports.ZidoAPI=new ZidoAPI),!1;function extractHostname(a){return a.split('/')[2].split(':')[0]}function getHostname(){var a=window.parent!==window;return a?extractHostname(document.referrer):window.top.location.hostname}function isDomainAllowed(a,b){if(-1!==b.indexOf('*'))return!0;const c=extractRootDomain(a);return-1!==b.indexOf(c)}function extractRootDomain(a){var b=a,c=b.split('.'),d=c.length;return 2<d&&(b=c[d-2]+'.'+c[d-1],2===c[d-2].length&&2===c[d-1].length&&(b=c[d-3]+'.'+b)),b}function sendCustomEvent(a,b={}){var c=new CustomEvent(a,{detail:b});window.dispatchEvent(c)}function showError(a,b){const c=document.createElement('div');addCss(ERROR_CSS),c.id=ERROR_ID;var d=document.createElement('img');if(d.className='locker',d.src='http://assets.zidoworld.com/assets/js/api-integration-helper/1.0/locker.svg',c.appendChild(d),b){var e=document.createElement('div');e.className='error-title',e.innerHTML=b,c.appendChild(e)}var f=document.createElement('div');f.className='error-message',f.innerHTML=a,c.appendChild(f),document.body.appendChild(c)}function showVideo(a,b){if(document.getElementById(VIDEO_ID))return;addCss(VIDEO_CSS);const c=document.createElement('video');c.id=VIDEO_ID,c.type='video/mp4',c.autoplay=!0,c.src=a,c.addEventListener('ended',removeVideoAndStartGame),c.addEventListener('error',removeVideoAndStartGame),b&&showSkipVideo();const d=addPlayButton(c);c.addEventListener('play',()=>hideThenRemoveNode(d)),document.body.appendChild(c)}function addPlayButton(){addCss(PLAY_CSS);const a=document.createElement('div'),b=document.createElement('button');return a.id=PLAY_ID,a.addEventListener('click',playVideo),b.classList.add('triangle-right','big'),document.body.appendChild(a),a.appendChild(b),a}function playVideo(){const a=document.getElementById(VIDEO_ID);a.play()}function showSkipVideo(){if(!document.getElementById(SKIP_ID)){addCss(SKIP_CSS);const a=document.createElement('div'),b=document.createElement('span'),c=document.createElement('span'),d=document.createElement('span');d.classList.add('text'),c.classList.add('vertical-bar'),b.classList.add('triangle-right','small'),d.innerText='\u062A\u062E\u0637\u064A',a.id=SKIP_ID,a.addEventListener('click',removeVideoAndStartGame),a.appendChild(b),a.appendChild(c),a.appendChild(d),document.body.appendChild(a)}}function removeVideoAndStartGame(){hideThenRemoveNode(document.getElementById(VIDEO_ID)),hideThenRemoveNode(document.getElementById(SKIP_ID)),hideThenRemoveNode(document.getElementById(PLAY_ID)),sendCustomEvent('startgame')}function hideThenRemoveNode(a){a&&(a.classList.add('hide'),setTimeout(()=>{a.parentNode.removeChild(a)},700))}function debounce(a,b){var c=null;return function(){var d=this,e=arguments;clearTimeout(c),c=setTimeout(function(){a.apply(d,e)},b)}}function addCss(a){const b=document.head,c=document.createElement('style');c.type='text/css',c.appendChild(document.createTextNode(a)),b.appendChild(c)}const VIDEO_ID='zido-intro',SKIP_ID='zido-skip',PLAY_ID='zido-play',ERROR_ID='zido-error',VIDEO_CSS=`#${'zido-intro'} {position: absolute;width: 100%;height: 100%;height:100%;margin: auto;top: 0px;left: 0px;transition: all .5s;overflow: hidden;z-index: 500;background-color: lightblue;border: 15px solid #32c8e8;box-sizing: border-box;}.hide{opacity: 0;transition: all .5s;}  `,PLAY_CSS=`#${'zido-play'} {position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);border-radius:50%;z-index: 700;cursor: pointer;background: #fef3df;box-shadow: 0px 6px #eccf9c;transition: all .5s;}#${'zido-play'}:hover {margin-top:6px;box-shadow: 0px 0px #eccf9c;transition: all .5s;}#${'zido-play'} button:hover {opacity:1;}#${'zido-play'} button{cursor: pointer;box-sizing: border-box;background: transparent;transform: scale(0.5) translateX(21%);opacity:.8;}.triangle-right {width: 0;height: 0;border-style:solid;border-color: transparent transparent transparent #f95428;}.triangle-right.small{border-width: 10px 0px 10px 20px;}.triangle-right.big {border-width: 37px 0px 37px 74px;}.vertical-bar{width: 0;height: 0;border-style:solid;border-color: #f95428;border-width: 0px 10px 20px 0px;}`,SKIP_CSS=`#${'zido-skip'} {font-family: 'Cairo', sans-serif;cursor: pointer;position: absolute;top: 5px;right: 5px;line-height: 40px;font-size: 20px;font-family: sans-serif;border-radius: 25%;box-shadow: 0 0 4px rgba(0,0,0,.4);z-index: 700;background: #ad9b88;color: #f95428;background:#ffeed1;padding: 9px 17px 3px 17px;}#${'zido-skip'} span {display: inline-block;}#${'zido-skip'} .text {margin-left: 19px;transform: translateY(-5px);}`,ERROR_CSS=`#${'zido-error'} {font-family: 'Cairo', sans-serif;background-color: #FFFFFF;color: #4A4A4A;position: absolute;top: 0;left: 0;display: block;width: 100%;min-height: 100%;text-align: center;font-size: 24pt;}.locker{width: 6%;display: block;margin: auto;margin-top: 8%;margin-bottom: 1em;}.error-title{font-size: 45pt;color: #FBB03B;font-weight: bold;}`;
